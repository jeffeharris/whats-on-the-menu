# Production multi-stage Dockerfile for What's On The Menu
# Builds the Vite SPA and runs the Express server with tsx

# ── Stage 1: Build ────────────────────────────────────────────
FROM node:22-alpine AS builder

WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci

COPY . .
RUN npm run build

# ── Stage 2: Runtime ──────────────────────────────────────────
FROM node:22-alpine AS runtime

RUN apk add --no-cache tini curl

WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci --omit=dev && npm install tsx

# Copy built SPA from builder stage
COPY --from=builder /app/dist ./dist

# Copy server TypeScript source (runs via tsx at runtime)
COPY server ./server

# Create non-root user
RUN addgroup -S appgroup && adduser -S appuser -G appgroup \
    && mkdir -p /app/data \
    && chown -R appuser:appgroup /app

USER appuser

EXPOSE 3001

ENTRYPOINT ["tini", "--"]
CMD ["npx", "tsx", "server/index.ts"]
